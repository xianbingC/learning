### 协议模型
#### OSI七层协议模型
1. **物理层**：通过媒介传输比特数据，RJ45，IEEE802.3；
2. **链路层**：比特数据组装成帧，点到点传递，PPP、HDLC、VLAN、MAC；
3. **网络层**：传递数据包，IP、ICMP、ARP；
4. **运输层**：提供端到端的报文传递，TCP、UDP、SPX；
5. **会话层**：建立和管理会话。NFS、RPC；
6. **表示层**：对数据进行加解密和压缩。JPEG、MPEG；
7. **应用层**：允许访问OS环境的手段。FTP、DNS、Telnet、SMTP、HTTP

#### TCP/IP协议模型
1. **链路层**：负责在以太网、WiFi这样的底层网络上发送原始数据，工作在网卡的层次，使用MAC地址来标记网络上的设备
2. **IP层**：用IP地址取代MAC地址，把许多局域网、广域网连接成一个虚拟的巨大网络，在这个网络里找设备时只有把IP地址再“翻译”成MAC地址就可以了。传输单位是“包”
3. **传输层**：负责保证数据在IP地址标记的两点之间“可靠”地传输。传输单位是“段”
4. **应用层**：有各种面向具体应用的协议，HTTP、FTP、SMTP等。传输单位是“消息或报文”

### TCP
#### 特点
1. 面向连接、端到端、可靠交付、全双工、面向字节流、首部开销20字节，流量控制和拥塞控制。
2. 如何保证可靠传输：确认和超时重传、合理分片和排序、流量控制、拥塞控制、数据校验。
3. TCP粘包：接收缓冲区中有多个数据包，由于TCP面向字节流，没有边界，所以可能造成当前报文和下一个报文粘在一起的情况。
4. TCP粘包解决方法：
  - 发送定长包。
  - 包头加上定长字节表示包的长度。
  - 数据包设置边界如\r\n标记。FTP协议就是这么做的。但如果正文中也有此标记就会发生误判。
  - 发送方关闭Nagle算法来解决
5. TCP拆包：数据较大时，一个完整的包可能会被拆成多个包进行发送
5. 流控：就是让发送方的发送速率不要太快，让接收方来得及接收。通过可变窗口进行流量控制。
6. 拥塞控制：慢开始、拥塞避免、快重传和快恢复。

#### 可靠传输
1. 校验和
    - 由发送端计算待发送 TCP 报文段的校验和，然后接收端对接收到的 TCP 报文段验证其校验和
2. 序列号和确认应答机制
    - TCP 报文段的首部中有一个序号字段指的是该报文段第一个字节的序号（一个字节占一个序号）。确认应答机制就是接收方收到 TCP 报文段后就会返回一个确认应答消息
3. 重传机制
    - 超时重传：数据包丢失、确认应答丢失，导致接收ack包超时（包往返时间）
    - 快速重传：当收到三个相同的ACK报文时，会在定时器过期之前，重传丢失的报文段。
4. 滑动窗口
    - 窗口，无需等待确认应答，可以继续发送数据包的最大值
5. 流量控制：接收端主机向发送端主机通知自己可以接收数据的大小，于是发送端会发送不超过这个限度的数据，**避免发送方的数据填满接收方的缓存**。
6. 拥塞控制
    - **控制的目的就是避免发送方的数据填满整个网络**，拥塞窗口 cwnd 是发送方维护的一个状态变量，它会根据网络的拥塞程度动态变化
    - 只要发送方没有在规定时间内接收到 ACK 应答报文，也就是发生了超时重传，就会认为网络出现了拥塞。
    - 拥塞控制算法：
        - 慢启动：发送方每收到一个 ACK，拥塞窗口cwnd的大小就会加1
        - 拥塞避免：cwnd达到阈值（一般65535字节）时，每当收到一个ACK，cwnd增加1/cwnd
        - 拥塞发生：当发生超时重传时，窗口阈值变为一半，cwnd重置为1，重新开始慢启动过程，会造成网络卡顿
        - 快速恢复：当发生快速重传时，cwnd变为阈值+3，重传丢失的数据包，若收到重复的ACK（重传仍未成功），cwnd加1，若收到新的数据包（重传成功），cwnd设置为阈值，进入拥塞避免算法

#### 三次握手
- **过程**
  1. 客户端发送SYN给服务端请求建立连接。
  2. 服务端接收到该包，回复一个SYN+ACK的包。
  3. 客户端收到后，回复一个ACK包。
- **为什么三次握手？**
  1. 两次握手会造成资源的浪费。
  2. 协商必要的信息，如窗口大小，数据包的起始序号。
  3. 检测双方的通信能力是否正常。

#### 四次挥手
- **过程**：
  1. 客户端发送FIN包，进入FIN_wait_1状态。
  2. 服务端收到后，发送ACK包，进入closed_wait状态
  3. 客户端收到后，进入FIN_wait_2状态
  4. 服务端发送FIN包，进入LAST_ACK状态。
  5. 客户端收到后，发送ACK包，进入time_wait状态
  6. 服务端收到后，进入closed状态，客户端经过2MSL（Maximum Segment Lifetime）时间后，进入closed状态。
    - **原因**：
  TCP通信是全双工的，一方申请关闭链接，但另一端可能还有数据要进行传输。
    - **为什么要2MSL才关闭**：确保最后一个ACK报文能够到达服务器。

### UDP
无连接、尽最大努力交付、面向报文、没有拥塞控制和流量控制、支持多种交互通信、首部开销8字节。

### 应用层
- DNS：域名解析协议。53号端口。
- FTP：文件传输协议。TCP21号端口。
- TFTP：简单文件传输协议。UDP。
- telnet：远程登录协议。
- HTTP：超文本传输协议。TCP80端口。HTTP协议的工作流程。
- SMTP：简单邮件传输协议。
- 状态码：100 Continue；200 OK；3xx重定向；400 Bad Request；401 要求身份认证；403 权限不够，拒绝访问。500 服务器内部错误；503 系统维护；504 网关超时。

### 参考链接
1. [TCP报文格式](https://blog.csdn.net/weixin_54542209/article/details/123282300)
2. [三次握手/四次挥手](https://blog.csdn.net/ChaseHeart/article/details/120217754)
3. [如何解决timewait过多的问题](https://blog.csdn.net/moumouren2016/article/details/106609125/)
4. [TCP连接断电或程序崩溃会发生什么？](https://zhuanlan.zhihu.com/p/581877778)
5. [套接字/五元组](https://blog.csdn.net/ZRXSLYG/article/details/113615448?spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-1-113615448-blog-118654515.pc_relevant_3mothn_strategy_recovery&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-1-113615448-blog-118654515.pc_relevant_3mothn_strategy_recovery&utm_relevant_index=2)
6. [从connect函数分析握手过程](https://blog.csdn.net/qq_35733751/article/details/80636224)
7. [udp与tcp协议的区别](https://www.cnblogs.com/lcc0/p/15987158.html)
8. [tcp粘包与拆包问题](https://www.jianshu.com/p/97fbf573fb44)
9. [tcp可靠传输原理](https://blog.csdn.net/m0_67392010/article/details/124777518)
